<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…Ø¯ÙˆÙ†Ø© â€” Ù…Ù‚Ø§Ù„Ø§ØªÙŠ</title>
  <meta name="theme-color" content="#0f172a" />
  <meta name="description" content="Ù…Ø¯ÙˆÙ†Ø© Ø´Ø®ØµÙŠØ© Ù…ØªÙ‚Ø¯Ù…Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª Ø¨ØµÙˆØ±Ø© Ø¹ØµØ±ÙŠØ© Ù…Ø¹ Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙˆØªØ¨Ø¯ÙŠÙ„ Ù†Ù‡Ø§Ø±ÙŠ/Ù„ÙŠÙ„ÙŠ." />

  <!-- ====== Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª ÙˆØ§Ù„ØªØµÙ…ÙŠÙ… ====== -->
  <style>
    /* Reset Ø®ÙÙŠÙ ÙˆÙ…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ RTL */
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Kufi Arabic","Noto Sans Arabic","Tahoma",Arial,sans-serif;line-height:1.6;background:var(--bg);color:var(--ink)}
    img{max-width:100%;display:block}
    button,input,select,textarea{font:inherit}
    :root{
      /* Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (ÙŠØ­ØªØ±Ù… ØªÙØ¶ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…) */
      --bg:#0b1020;          /* Ø®Ù„ÙÙŠØ© Ø¹Ø§Ù…Ø© */
      --paper:#0f172a;       /* Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
      --ink:#e5e7eb;         /* Ù†Øµ Ø£Ø³Ø§Ø³ÙŠ */
      --muted:#94a3b8;       /* Ù†Øµ Ø¨Ø§Ù‡Øª */
      --ring:rgba(34,211,238,.35);
      --brand:#22d3ee;       /* Ø£Ø²Ø±Ù‚ Ø³Ù…Ø§ÙˆÙŠ */
      --accent:#7c3aed;      /* Ø¨Ù†ÙØ³Ø¬ÙŠ */
      --success:#10b981;
      --danger:#ef4444;
      --card:#0f172a;
      --card-border:rgba(148,163,184,.2);
      --shadow:0 10px 30px rgba(2,6,23,.4);
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f6f7fb;
        --paper:#ffffff;
        --ink:#0f172a;
        --muted:#475569;
        --ring:rgba(124,58,237,.25);
        --brand:#0ea5e9;
        --accent:#7c3aed;
        --card:#ffffff;
        --card-border:rgba(15,23,42,.08);
        --shadow:0 10px 24px rgba(2,6,23,.08);
      }
    }
    /* Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ… ÙŠØ¯ÙˆÙŠÙ‹Ø§ */
    html[data-theme="dark"]{
      --bg:#0b1020;--paper:#0f172a;--ink:#e5e7eb;--muted:#94a3b8;--ring:rgba(34,211,238,.35);
      --brand:#22d3ee;--accent:#7c3aed;--card:#0f172a;--card-border:rgba(148,163,184,.2);
      --shadow:0 10px 30px rgba(2,6,23,.4);
    }
    html[data-theme="light"]{
      --bg:#f6f7fb;--paper:#ffffff;--ink:#0f172a;--muted:#475569;--ring:rgba(124,58,237,.25);
      --brand:#0ea5e9;--accent:#7c3aed;--card:#ffffff;--card-border:rgba(15,23,42,.08);
      --shadow:0 10px 24px rgba(2,6,23,.08);
    }

    /* Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ */
    .topbar{
      position:sticky;top:0;z-index:50;
      backdrop-filter:saturate(160%) blur(10px);
      background:linear-gradient(180deg, rgba(2,6,23,.8), rgba(2,6,23,.4));
      border-bottom:1px solid var(--card-border);
      padding:.6rem .9rem;
    }
    html[data-theme="light"] .topbar{background:linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.7))}
    .container{max-width:1100px;margin-inline:auto;padding:0 1rem}
    .row{display:flex;align-items:center;justify-content:space-between;gap:.75rem}
    .brand{display:flex;align-items:center;gap:.6rem;font-weight:800;letter-spacing:.3px}
    .logo{
      inline-size:36px;block-size:36px;border-radius:50%;
      background:conic-gradient(from 210deg,var(--brand),var(--accent));
      box-shadow:0 0 0 4px rgba(124,58,237,.15);
    }
    .brand span{font-size:1.05rem}

    /* Ø£Ø²Ø±Ø§Ø± Ø¹Ø§Ù…Ø© */
    .btn{
      display:inline-flex;align-items:center;gap:.5rem;
      padding:.55rem .85rem;border-radius:999px;border:1px solid transparent;
      background:linear-gradient(180deg,var(--brand),var(--accent));color:white;
      box-shadow:0 8px 20px rgba(124,58,237,.35);cursor:pointer;
      transition:.2s transform,.2s filter,.2s box-shadow;
      user-select:none;white-space:nowrap
    }
    .btn:hover{transform:translateY(-1px);filter:saturate(115%);box-shadow:0 12px 30px rgba(124,58,237,.45)}
    .btn.secondary{background:transparent;color:var(--ink);border-color:var(--card-border);box-shadow:none}
    .btn.ghost{background:transparent;color:var(--ink);border:1px dashed var(--card-border)}
    .icon{font-style:normal}

    /* Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ù…ØµØºÙ‘Ø± */
    .avatar-wrap{display:flex;align-items:center;gap:.6rem}
    .avatar{
      inline-size:40px;block-size:40px;border-radius:50%;overflow:hidden;border:1px solid var(--card-border);
      background:radial-gradient(120px 120px at 20% 20%, var(--accent), transparent),
                 radial-gradient(140px 140px at 80% 80%, var(--brand), transparent),
                 linear-gradient(135deg, #222, #111);
      box-shadow:0 6px 18px rgba(0,0,0,.25)
    }
    .avatar img{inline-size:100%;block-size:100%;object-fit:cover}

    /* Ø´Ø±ÙŠØ· Ø£Ø¯ÙˆØ§Øª */
    .actions{display:flex;align-items:center;gap:.5rem;flex-wrap:wrap}

    /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
    main{padding:1.1rem 0}
    .grid{
      display:grid;gap:1rem;
      grid-template-columns:1fr;
    }
    @media (min-width:680px){.grid{grid-template-columns:1fr 1fr}}
    @media (min-width:1024px){.grid{grid-template-columns:1fr 1fr 1fr}}

    /* Ø¨Ø·Ø§Ù‚Ø© Ù…Ù‚Ø§Ù„ */
    .card{
      background:var(--card);
      border:1px solid var(--card-border);
      border-radius:18px;overflow:hidden;
      box-shadow:var(--shadow);
      transition:.25s transform cubic-bezier(.2,.6,.3,1), .25s box-shadow;
      display:flex;flex-direction:column;min-height:100%;
    }
    .card:hover{transform:translateY(-3px)}
    .cover{aspect-ratio:16/9;object-fit:cover;background:#111}
    .content{padding:1rem 1rem 0.5rem}
    .meta{display:flex;align-items:center;justify-content:space-between;gap:.5rem;margin-bottom:.35rem}
    .title{margin:0;font-size:1rem}
    .date{font-size:.8rem;color:var(--muted)}
    .tags{display:flex;flex-wrap:wrap;gap:.35rem;margin:.4rem 0 .6rem}
    .tag{font-size:.75rem;padding:.2rem .55rem;border-radius:999px;background:rgba(124,58,237,.12);border:1px solid rgba(124,58,237,.22)}
    .excerpt{color:var(--muted);margin:.2rem 0 .9rem}
    .card .controls{display:flex;gap:.5rem;margin:.6rem 1rem 1rem}
    .card .controls .btn{padding:.45rem .75rem}

    /* Ù„ÙˆØ­Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù…Ø¹ Ø£Ù†ÙŠÙ…ÙŠØ´Ù† ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ */
    .details{
      overflow:hidden;height:0;opacity:0;transition:height .35s ease, opacity .3s ease;
      border-top:1px dashed var(--card-border);margin:0 1rem 1rem;border-radius:12px;padding:0 .2rem;
    }
    .details.open{opacity:1}
    .details-content{padding:.9rem .2rem .8rem;color:var(--ink)}
    .details p{margin:.5rem 0}

    /* Ù…ÙˆØ¯Ø§Ù„ */
    .modal{
      position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.45);z-index:100;
      padding:1rem
    }
    .modal.open{display:grid;animation:fadeIn .15s ease}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .sheet{
      width:min(780px,100%);max-height:90vh;overflow:auto;background:var(--paper);border:1px solid var(--card-border);
      border-radius:18px;box-shadow:var(--shadow);padding:1rem
    }
    .sheet h3{margin:0 0 .8rem}
    .form{display:grid;gap:.8rem}
    .row2{display:grid;gap:.8rem;grid-template-columns:1fr}
    @media (min-width:640px){.row2{grid-template-columns:1fr 1fr}}
    .field{display:grid;gap:.35rem}
    .field label{font-size:.9rem;color:var(--muted)}
    .field input[type="text"], .field textarea{
      padding:.65rem .75rem;border-radius:12px;border:1px solid var(--card-border);background:transparent;color:var(--ink)
    }
    .field textarea{min-height:140px;resize:vertical}
    .muted{color:var(--muted);font-size:.85rem}

    /* Ø´Ø±ÙŠØ· Ø³ÙÙ„ÙŠ ØµØºÙŠØ± */
    footer{padding:1.2rem 0;color:var(--muted);text-align:center}

    /* ØªØ±ÙƒÙŠØ² ÙˆØ§Ø¶Ø­ Ù„Ù„ÙˆØµÙˆÙ„ÙŠØ© */
    :focus-visible{outline:3px solid var(--ring);outline-offset:2px;border-radius:12px}

    /* ====== Ù‚ÙˆØ§Ø¦Ù… Ù…Ù†Ø¨Ø«Ù‚Ø© ØµØºÙŠØ±Ø© (Popover) ====== */
    .popover{
      position:fixed;display:none;min-width:220px;background:var(--paper);
      border:1px solid var(--card-border);box-shadow:var(--shadow);border-radius:14px;
      padding:.35rem;z-index:120
    }
    .popover.open{display:block;animation:fadeIn .12s ease}
    .menu{display:grid}
    .item{
      background:transparent;border:0;text-align:right;padding:.6rem .8rem;border-radius:10px;
      color:var(--ink);cursor:pointer
    }
    .item:hover{background:rgba(124,58,237,.08)}
    .divider{height:1px;background:var(--card-border);margin:.35rem .2rem}
    .small{color:var(--muted);font-size:.85rem;padding:.25rem .8rem .4rem}
  </style>
</head>
<body>
  <!-- ====== Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ ====== -->
  <header class="topbar">
    <div class="container row">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <span>Ù…Ø¯ÙˆÙ†Ø© â€” Ù…Ù‚Ø§Ù„Ø§ØªÙŠ</span>
      </div>
      <div class="actions">
        <button class="btn secondary" id="themeToggle" aria-label="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹"><i class="icon">ğŸŒ“</i><span>Ù†Ù‡Ø§Ø±/Ù„ÙŠÙ„</span></button>

        <div class="avatar-wrap">
          <div class="avatar" id="avatarBox" aria-label="ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„"><img id="avatarImg" alt="ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„"></div>
          <button class="btn ghost" id="changeAvatarBtn"><i class="icon">ğŸ–¼ï¸</i><span>ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©</span></button>
          <input type="file" id="avatarInput" accept="image/*" hidden>
        </div>

        <!-- Ø²Ø± Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø© -->
        <button class="btn secondary" id="contactBtn" aria-haspopup="menu"><i class="icon">ğŸ“§</i><span>Ù…Ø±Ø§Ø³Ù„Ø©</span></button>
        <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø© -->
        <div class="popover" id="contactMenu" role="menu" aria-hidden="true">
          <div class="menu">
            <div class="small">Ø§Ù„Ø¨Ø±ÙŠØ¯: <b id="emailText">waseemjamal.2040@gmail.com</b></div>
            <button class="item" id="mailtoBtn">ÙØªØ­ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø±ÙŠØ¯</button>
            <button class="item" id="copyEmailBtn">Ù†Ø³Ø® Ø§Ù„Ø¨Ø±ÙŠØ¯</button>
          </div>
        </div>

        <!-- Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ -->
        <button class="btn ghost" id="backupBtn" aria-haspopup="menu"><i class="icon">ğŸ’¾</i><span>Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</span></button>
        <div class="popover" id="backupMenu" role="menu" aria-hidden="true">
          <div class="menu">
            <button class="item" id="exportBtn">ØªØµØ¯ÙŠØ± JSON</button>
            <button class="item" id="importBtn">Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON</button>
          </div>
        </div>
        <input type="file" id="importInput" accept="application/json" hidden>

        <button class="btn" id="addBtn"><i class="icon">âœï¸</i><span>Ø¥Ø¶Ø§ÙØ© Ù…Ù‚Ø§Ù„</span></button>
      </div>
    </div>
  </header>

  <!-- ====== Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ====== -->
  <main class="container">
    <section id="articlesGrid" class="grid" aria-live="polite"></section>
  </main>

  <footer class="container">
    <small>ğŸš€ ÙƒÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ØªÙØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­ (localStorage). Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù„Ù†Ù‚Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨ÙŠÙ† Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©.</small>
  </footer>

  <!-- ====== Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ù…Ù‚Ø§Ù„ ====== -->
  <div class="modal" id="articleModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="sheet">
      <h3 id="modalTitle">Ø¥Ø¶Ø§ÙØ© Ù…Ù‚Ø§Ù„</h3>
      <form id="articleForm" class="form">
        <div class="row2">
          <div class="field">
            <label for="title">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
            <input id="title" type="text" required placeholder="Ø§ÙƒØªØ¨ Ø¹Ù†ÙˆØ§Ù†Ù‹Ø§ Ø¬Ø°Ù‘Ø§Ø¨Ù‹Ø§">
          </div>
          <div class="field">
            <label for="tags">ÙˆØ³ÙˆÙ… (Ø§ÙØµÙ„ Ø¨ÙŠÙ†Ù‡Ø§ Ø¨ÙØ§ØµÙ„Ø©)</label>
            <input id="tags" type="text" placeholder="ØªÙ‚Ù†ÙŠØ©, ØªØµÙ…ÙŠÙ…, ÙˆÙŠØ¨">
          </div>
        </div>
        <div class="field">
          <label for="excerpt">Ù…Ù„Ø®Øµ Ù‚ØµÙŠØ±</label>
          <input id="excerpt" type="text" maxlength="160" placeholder="Ø³Ø·Ø± ÙŠÙ„Ø®Øµ Ø§Ù„Ù…Ù‚Ø§Ù„">
        </div>
        <div class="field">
          <label for="content">Ø§Ù„Ù…Ø­ØªÙˆÙ‰</label>
          <textarea id="content" required placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙƒØ§Ù…Ù„ Ù‡Ù†Ø§"></textarea>
        </div>
        <div class="row2">
          <div class="field">
            <label for="cover">ØµÙˆØ±Ø© Ø§Ù„ØºÙ„Ø§Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="cover" type="file" accept="image/*">
            <small class="muted">ÙŠØªÙ… Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¯Ø§Ø¡.</small>
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <div class="muted">ØªÙ„Ù…ÙŠØ­: ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù‚Ø§Ù„ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø£Ùˆ Ø­Ø°ÙÙÙ‡ Ø¨Ø³Ù‡ÙˆÙ„Ø©.</div>
          </div>
        </div>
        <div class="actions" style="justify-content:flex-end">
          <button type="button" class="btn secondary" id="cancelModal">Ø¥Ù„ØºØ§Ø¡</button>
          <button type="submit" class="btn" id="saveArticleBtn">Ø­ÙØ¸</button>
        </div>
        <input type="hidden" id="editingId" value="">
      </form>
    </div>
  </div>

  <!-- ====== Ø³ÙƒØ±Ø¨Øª Ø§Ù„ÙˆØ¸Ø§Ø¦Ù ====== -->
  <script>
    // Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªØ®Ø²ÙŠÙ†
    const STORAGE_KEY = 'blog.articles.v2';
    const PROFILE_KEY = 'blog.profile.v1';
    const THEME_KEY   = 'blog.theme.v1';

    // ====== Ø¨Ø±ÙŠØ¯Ùƒ ======
    const EMAIL = 'waseemjamal.2040@gmail.com';

    // Ø¹Ù†Ø§ØµØ± DOM
    const grid = document.getElementById('articlesGrid');
    const modal = document.getElementById('articleModal');
    const form = document.getElementById('articleForm');
    const titleInp = document.getElementById('title');
    const tagsInp = document.getElementById('tags');
    const excerptInp = document.getElementById('excerpt');
    const contentInp = document.getElementById('content');
    const coverInp = document.getElementById('cover');
    const editingId = document.getElementById('editingId');
    const modalTitle = document.getElementById('modalTitle');
    const cancelModalBtn = document.getElementById('cancelModal');
    const addBtn = document.getElementById('addBtn');
    const themeToggle = document.getElementById('themeToggle');
    const avatarImg = document.getElementById('avatarImg');
    const avatarInput = document.getElementById('avatarInput');
    const changeAvatarBtn = document.getElementById('changeAvatarBtn');

    // Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆØ§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
    const contactBtn = document.getElementById('contactBtn');
    const contactMenu = document.getElementById('contactMenu');
    const emailText = document.getElementById('emailText');
    const mailtoBtn = document.getElementById('mailtoBtn');
    const copyEmailBtn = document.getElementById('copyEmailBtn');

    const backupBtn = document.getElementById('backupBtn');
    const backupMenu = document.getElementById('backupMenu');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const importInput = document.getElementById('importInput');

    // ====== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ======
    const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));

    function lsGet(key, fallback){
      try{const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback;}
      catch{ return fallback }
    }
    function lsSet(key, value){
      try{ localStorage.setItem(key, JSON.stringify(value)); }
      catch(e){ alert('ØªØ¹Ø°Ø± Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ù„ÙŠ: ' + (e?.message||e)) }
    }

    function formatDate(ts){
      const d = new Date(ts);
      return d.toLocaleDateString('ar-EG', {year:'numeric', month:'long', day:'numeric'});
    }

    function createId(){ return 'a_' + Math.random().toString(36).slice(2) + Date.now().toString(36) }

    // Ø¶ØºØ· ØµÙˆØ±Ø© Ø¥Ù„Ù‰ DataURL (JPEG) Ù…Ø¹ Ø­Ø¯ Ø£Ù‚ØµÙ‰ Ù„Ù„Ø£Ø¨Ø¹Ø§Ø¯
    async function fileToDataURLCompressed(file, maxW=1400, maxH=900, quality=.85){
      if(!file) return null;
      const bitmap = await createImageBitmap(file);
      let {width:w, height:h} = bitmap;
      const ratio = Math.min(maxW / w, maxH / h, 1);
      const canvas = document.createElement('canvas');
      canvas.width = Math.round(w * ratio);
      canvas.height = Math.round(h * ratio);
      const ctx = canvas.getContext('2d');
      ctx.drawImage(bitmap, 0, 0, canvas.width, canvas.height);
      const blob = await new Promise(res=>canvas.toBlob(res, 'image/jpeg', quality));
      const reader = new FileReader();
      return await new Promise((resolve, reject)=>{
        reader.onload = ()=>resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }

    // ====== Ø§Ù„Ø«ÙŠÙ… ======
    function applyTheme(theme){
      if(theme==='light'||theme==='dark'){ document.documentElement.setAttribute('data-theme', theme); }
      else{ document.documentElement.removeAttribute('data-theme'); } // Ø§Ø³ØªØ®Ø¯Ù… ØªÙØ¶ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…
    }
    function initTheme(){
      const saved = lsGet(THEME_KEY, null);
      applyTheme(saved);
    }
    themeToggle.addEventListener('click', ()=>{
      const current = document.documentElement.getAttribute('data-theme') || 'auto';
      const next = current==='dark' ? 'light' : current==='light' ? null : 'dark';
      applyTheme(next);
      lsSet(THEME_KEY, next);
    });

    // ====== Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ ======
    function renderAvatar(){
      const p = lsGet(PROFILE_KEY, {});
      if(p.avatar){ avatarImg.src = p.avatar; }
      else{
        // ØµÙˆØ±Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© SVG Ø£Ù†ÙŠÙ‚Ø©
        const svg = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 120">
            <defs>
              <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
                <stop offset="0" stop-color="#22d3ee"/><stop offset="1" stop-color="#7c3aed"/>
              </linearGradient>
            </defs>
            <rect width="120" height="120" fill="#111"/>
            <circle cx="60" cy="60" r="58" fill="url(#g)" opacity=".25"/>
            <circle cx="60" cy="48" r="20" fill="#fff" opacity=".9"/>
            <rect x="25" y="76" width="70" height="30" rx="15" fill="#fff" opacity=".9"/>
          </svg>`;
        avatarImg.src = 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
      }
    }
    changeAvatarBtn.addEventListener('click', ()=> avatarInput.click());
    avatarInput.addEventListener('change', async ()=>{
      const file = avatarInput.files?.[0];
      if(!file) return;
      const dataUrl = await fileToDataURLCompressed(file, 512, 512, .9);
      const p = lsGet(PROFILE_KEY, {});
      p.avatar = dataUrl;
      lsSet(PROFILE_KEY, p);
      renderAvatar();
    });

    // ====== Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ======
    function loadArticles(){
      const a = lsGet(STORAGE_KEY, null);
      if(a && Array.isArray(a)) return a;
      // Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„ÙŠØ© Ø£Ù†ÙŠÙ‚Ø©
      const seed = [
        {
          id:createId(), title:'Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ù…Ø¯ÙˆÙ†ØªÙƒ ğŸ‘‹', tags:['ØªØ¹Ù„ÙŠÙ…Ø§Øª','Ø¨Ø¯Ø¡ Ø³Ø±ÙŠØ¹'],
          excerpt:'Ù‡Ø°Ø§ Ù…Ø«Ø§Ù„ Ù„Ù…Ù‚Ø§Ù„ ØªØ¬Ø±ÙŠØ¨ÙŠ. ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„Ù‡ Ø£Ùˆ Ø­Ø°ÙÙ‡ØŒ Ø£Ùˆ Ø¥Ø¶Ø§ÙØ© Ù…Ù‚Ø§Ù„Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ø²Ø± Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰.',
          content:`Ù‡Ø°Ù‡ Ù…Ø¯ÙˆÙ†ØªÙƒ Ø§Ù„Ø®ÙÙŠÙØ© ØªØ¹Ù…Ù„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªØµÙØ­ ÙˆØªØ¯Ø¹Ù… Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ.

- Ù„Ø­ÙØ¸ ØµÙˆØ±Ø© Ø¨Ø±ÙˆÙØ§ÙŠÙ„Ùƒ Ø§Ø¶ØºØ· "ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©".
- Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ù‚Ø§Ù„: Ø§Ø¶ØºØ· "Ø¥Ø¶Ø§ÙØ© Ù…Ù‚Ø§Ù„".
- Ø§Ø¶ØºØ· "Ù‚Ø±Ø§Ø¡Ø©" Ù„ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ø¹ ØªØ£Ø«ÙŠØ± Ù„Ø·ÙŠÙ.
- ÙŠØ¯Ø¹Ù… Ø§Ù„ÙˆØ¶Ø¹ÙŠÙ† Ù†Ù‡Ø§Ø±ÙŠ/Ù„ÙŠÙ„ÙŠ ÙˆÙŠØ­ØªØ±Ù… ØªÙØ¶ÙŠÙ„ Ù†Ø¸Ø§Ù…Ùƒ.`,
          cover:null, createdAt:Date.now()-86400000*2
        },
        {
          id:createId(), title:'ØªØµÙ…ÙŠÙ… Ø¹ØµØ±ÙŠ ÙˆÙ…ØªØ¬Ø§ÙˆØ¨', tags:['ÙˆØ§Ø¬Ù‡Ø©','CSS','Responsive'],
          excerpt:'Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ØªØ³ØªØ®Ø¯Ù… Grid ÙˆØªØªÙƒÙŠÙ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ø¹ Ø§Ù„Ù‡Ø§ØªÙ ÙˆØ§Ù„ØªØ§Ø¨Ù„Øª ÙˆØ§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±.',
          content:'ØªÙ… Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø´Ø¨ÙƒØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… CSS Grid Ù…Ø¹ Ù†Ø³Ø¨ ÙˆØªØ¨Ø§Ø¹Ø¯Ø§Øª Ù…Ø¯Ø±ÙˆØ³Ø©. ÙƒÙ…Ø§ ØªÙ… Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù… Ø¨Ø¥Ø¸Ù‡Ø§Ø± Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø³Ù„Ø³ Ø¹Ù†Ø¯ ÙØªØ­ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‚Ø§Ù„.',
          cover:null, createdAt:Date.now()-86400000
        }
      ];
      lsSet(STORAGE_KEY, seed);
      return seed;
    }
    function saveArticles(list){ lsSet(STORAGE_KEY, list); }

    // ====== Ø§Ù„Ø¹Ø±Ø¶ ======
    function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m])) }

    function createCard(a){
      const wrap = document.createElement('article');
      wrap.className = 'card';
      const cover = document.createElement('img');
      cover.className = 'cover';
      cover.alt = a.title;
      cover.src = a.cover || 'data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 675"><defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#0ea5e9"/><stop offset="1" stop-color="#7c3aed"/></linearGradient></defs><rect width="1200" height="675" fill="#0f172a"/><rect x="0" y="0" width="1200" height="675" fill="url(#g)" opacity=".25"/><text x="50%" y="52%" font-size="64" fill="#ffffffcc" text-anchor="middle" font-family="system-ui,Segoe UI,Arial">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø© ØºÙ„Ø§Ù</text></svg>`);
      const content = document.createElement('div');
      content.className = 'content';
      const meta = document.createElement('div'); meta.className = 'meta';
      const h = document.createElement('h3'); h.className='title'; h.textContent = a.title;
      const date = document.createElement('div'); date.className='date'; date.textContent = formatDate(a.createdAt);
      meta.append(h, date);

      const tags = document.createElement('div'); tags.className='tags';
      (a.tags||[]).filter(Boolean).slice(0,6).forEach(t=>{ const span=document.createElement('span'); span.className='tag'; span.textContent = '#'+t.trim(); tags.appendChild(span); });

      const ex = document.createElement('p'); ex.className='excerpt'; ex.textContent = a.excerpt || (a.content?.slice(0,120) || '') + (a.content?.length>120?'â€¦':'');

      const ctrls = document.createElement('div'); ctrls.className='controls';
      const readBtn = btn('secondary','ğŸ“–','Ù‚Ø±Ø§Ø¡Ø©');
      const editBtn = btn('ghost','âœï¸','ØªØ¹Ø¯ÙŠÙ„');
      const delBtn  = btn('ghost','ğŸ—‘ï¸','Ø­Ø°Ù');
      ctrls.append(readBtn, editBtn, delBtn);

      const details = document.createElement('div'); details.className='details';
      const body = document.createElement('div'); body.className='details-content';
      // Ø­ÙˆÙ‘Ù„ Ø£Ø³Ø·Ø± Ù„ÙÙ‚Ù€Ø±Ø§Øª Ø¨Ø³ÙŠØ·Ø©
      body.innerHTML = a.content.split(/\n{2,}/).map(p=>`<p>${escapeHtml(p).replace(/\n/g,'<br>')}</p>`).join('');
      details.appendChild(body);

      content.append(meta, tags, ex);
      wrap.append(cover, content, ctrls, details);

      // ØªÙØ§Ø¹Ù„ ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ù…Ø¹ Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ø±ØªÙØ§Ø¹
      let isOpen = false;
      function setOpen(open){
        isOpen = open;
        if(open){
          details.classList.add('open');
          details.style.height = 'auto';
          const h = details.clientHeight+'px';
          details.style.height = '0px';
          // enforce reflow
          details.offsetHeight;
          details.style.height = h;
        }else{
          details.style.height = details.clientHeight+'px';
          // enforce reflow
          details.offsetHeight;
          details.style.height = '0px';
          details.addEventListener('transitionend', ()=>details.classList.remove('open'), {once:true});
        }
      }
      details.addEventListener('transitionend', ()=>{ if(isOpen){ details.style.height='auto'; }});

      readBtn.addEventListener('click', ()=> setOpen(!isOpen));
      cover.addEventListener('click', ()=> setOpen(!isOpen));
      h.addEventListener('click', ()=> setOpen(!isOpen));

      editBtn.addEventListener('click', ()=> openEditor(a));
      delBtn.addEventListener('click', ()=> deleteArticle(a.id));

      return wrap;
    }

    function btn(kind, icon, label){
      const b = document.createElement('button');
      b.className = 'btn ' + kind;
      const i = document.createElement('i'); i.className='icon'; i.textContent=icon;
      const s = document.createElement('span'); s.textContent = label;
      b.append(i,s); return b;
    }

    function render(){
      grid.innerHTML = '';
      const data = loadArticles().slice().sort((a,b)=> b.createdAt - a.createdAt);
      if(!data.length){
        const empty = document.createElement('div');
        empty.className='card';
        empty.innerHTML = `<div class="content"><h3 class="title">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‚Ø§Ù„Ø§Øª Ø¨Ø¹Ø¯</h3><p class="excerpt">Ø§Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙƒ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "Ø¥Ø¶Ø§ÙØ© Ù…Ù‚Ø§Ù„".</p></div>`;
        grid.appendChild(empty);
        return;
      }
      for(const a of data){ grid.appendChild(createCard(a)); }
    }

    // ====== CRUD ======
    function openEditor(article=null){
      modal.classList.add('open');
      document.body.style.overflow='hidden';
      if(article){
        modalTitle.textContent='ØªØ¹Ø¯ÙŠÙ„ Ù…Ù‚Ø§Ù„';
        titleInp.value = article.title || '';
        tagsInp.value = (article.tags||[]).join(', ');
        excerptInp.value = article.excerpt || '';
        contentInp.value = article.content || '';
        editingId.value = article.id;
        coverInp.value = '';
      }else{
        modalTitle.textContent='Ø¥Ø¶Ø§ÙØ© Ù…Ù‚Ø§Ù„';
        form.reset();
        editingId.value = '';
      }
      titleInp.focus();
    }
    function closeEditor(){
      modal.classList.remove('open');
      document.body.style.overflow='';
    }

    async function upsertArticle(e){
      e.preventDefault();
      const id = editingId.value || createId();
      const now = Date.now();
      const tags = tagsInp.value.split(',').map(s=>s.trim()).filter(Boolean);
      const coverFile = coverInp.files?.[0];
      let coverData = null;
      if(coverFile){ coverData = await fileToDataURLCompressed(coverFile, 1600, 1000, .85); }

      const data = loadArticles();
      const idx = data.findIndex(x=>x.id===id);
      if(idx>=0){
        // ØªØ­Ø¯ÙŠØ«
        const prev = data[idx];
        data[idx] = {
          ...prev,
          title:titleInp.value.trim(),
          tags,
          excerpt:excerptInp.value.trim(),
          content:contentInp.value.trim(),
          cover: coverData || prev.cover,
          // Ù„Ø§ Ù†ØºÙŠÙ‘Ø± createdAt
        };
      }else{
        data.push({
          id, title:titleInp.value.trim(), tags,
          excerpt:excerptInp.value.trim(), content:contentInp.value.trim(),
          cover: coverData, createdAt:now
        });
      }
      saveArticles(data);
      closeEditor();
      await sleep(60);
      render();
    }

    function deleteArticle(id){
      if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¨Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚Ø§Ù„ØŸ')) return;
      const data = loadArticles().filter(a=>a.id!==id);
      saveArticles(data);
      render();
    }

    // ====== Popover Ø¹Ø§Ù… ======
    function togglePopover(menuEl, anchorBtn){
      const isOpen = menuEl.classList.contains('open');
      closeAllPopovers();
      if(isOpen) return;
      const r = anchorBtn.getBoundingClientRect();
      const top = r.bottom + 8 + window.scrollY;
      const left = Math.max(8, r.right - 240 + window.scrollX);
      menuEl.style.top = top + 'px';
      menuEl.style.left = left + 'px';
      menuEl.classList.add('open');
    }
    function closeAllPopovers(){ contactMenu.classList.remove('open'); backupMenu.classList.remove('open'); }
    document.addEventListener('click', (e)=>{
      if(e.target.closest('#contactMenu, #contactBtn, #backupMenu, #backupBtn')) return;
      closeAllPopovers();
    });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeAllPopovers(); });

    // ====== Ù…Ø±Ø§Ø³Ù„Ø© ======
    emailText.textContent = EMAIL;
    contactBtn.addEventListener('click', ()=> togglePopover(contactMenu, contactBtn));
    mailtoBtn.addEventListener('click', ()=>{
      const subject = 'Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ø¯ÙˆÙ†Ø©';
      const body = 'Ø£Ù‡Ù„Ø§Ù‹ ÙˆØ³Ù‡Ù„Ø§Ù‹ØŒ%0D%0A%0D%0A(Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§)';
      window.location.href = `mailto:${EMAIL}?subject=${encodeURIComponent(subject)}&body=${body}`;
      closeAllPopovers();
    });
    async function copyText(text){
      try{
        await navigator.clipboard.writeText(text);
        alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¨Ø±ÙŠØ¯ âœ…');
      }catch{
        // fallback
        const ok = prompt('Ø§Ù†Ø³Ø® Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙŠØ¯ÙˆÙŠÙ‹Ø§:', text);
        if(ok!==null) alert('ØªÙ… Ø§Ù„Ø¹Ø±Ø¶ Ù„Ù„Ù†Ø³Ø®.');
      }
    }
    copyEmailBtn.addEventListener('click', ()=> copyText(EMAIL));

    // ====== Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ (ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯) ======
    backupBtn.addEventListener('click', ()=> togglePopover(backupMenu, backupBtn));

    function exportBackup(){
      const payload = {
        version:1,
        exportedAt:new Date().toISOString(),
        profile: lsGet(PROFILE_KEY, {}),
        theme: lsGet(THEME_KEY, null),
        articles: lsGet(STORAGE_KEY, [])
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'blog-backup-' + new Date().toISOString().slice(0,10) + '.json';
      document.body.appendChild(a);
      a.click();
      URL.revokeObjectURL(a.href);
      a.remove();
      closeAllPopovers();
    }
    exportBtn.addEventListener('click', exportBackup);

    importBtn.addEventListener('click', ()=> { importInput.value=''; importInput.click(); closeAllPopovers(); });
    importInput.addEventListener('change', async ()=>{
      const file = importInput.files?.[0];
      if(!file) return;
      try{
        const text = await file.text();
        const data = JSON.parse(text);
        if(!data || !Array.isArray(data.articles)) throw new Error('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­');
        // Ø¯Ù…Ø¬ Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª Ø­Ø³Ø¨ id (ØªÙÙˆØ² Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯)
        const current = lsGet(STORAGE_KEY, []);
        const map = new Map(current.map(a=>[a.id, a]));
        for(const a of data.articles){ if(a && a.id) map.set(a.id, a); }
        lsSet(STORAGE_KEY, Array.from(map.values()));
        if(data.profile) lsSet(PROFILE_KEY, data.profile);
        if('theme' in data) lsSet(THEME_KEY, data.theme);
        alert('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­ âœ…');
        renderAvatar(); render();
      }catch(err){
        alert('ØªØ¹Ø°Ø± Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: ' + (err?.message||err));
      }
    });

    // ====== Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ======
    addBtn.addEventListener('click', ()=> openEditor(null));
    cancelModalBtn.addEventListener('click', closeEditor);
    modal.addEventListener('click', (e)=>{ if(e.target===modal) closeEditor() });
    form.addEventListener('submit', upsertArticle);

    // ====== ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ ======
    (function init(){
      initTheme();
      renderAvatar();
      render();
    })();
  </script>
</body>
</html>